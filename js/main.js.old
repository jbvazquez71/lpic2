let arr = []; 
let arrOpt = ["A","B","C","D","E"];
let rand = 0;
let preguntas_hechas = [];
let numCorrect = 0;
let numIncorrect = 0;
let totalSeconds = 0;
let errorStats = {};

const TEMAS = {
    "DNS / BIND": ["dns", "bind", "named", "dig", "ptr", "soa", "zone"],
    "Apache / Nginx": ["httpd", "apache", "nginx", "ssl", "cert", "vhost", "proxy_pass"],
    "Samba / CIFS": ["samba", "smb", "cifs", "winbind", "nmbd"],
    "Correo (Postfix/Dovecot)": ["postfix", "dovecot", "smtp", "imap", "sieve", "mail"],
    "Redes e IPv6": ["ipv6", "ip6tables", "router", "forwarding", "dhcp"],
    "OpenLDAP": ["ldap", "slapd", "ldif", "dn:", "ou="],
    "Seguridad / PAM": ["pam", "fail2ban", "ssh", "keygen", "nmap", "iptables"]
};

// Función para cambiar de examen sin fetch
function switchExam(examKey) {
    if(examKey === "LPIC2_1") arr = preguntasLPIC2_1;
    else if(examKey === "LPIC2_2") arr = preguntasLPIC2_2;
    else if(examKey === "LPIC1") arr = preguntasLPIC1;
    
    resetStats();
    nextQuestion();
}

function resetStats() {
    preguntas_hechas = [];
    numCorrect = 0;
    numIncorrect = 0;
    errorStats = {};
    $("#mainCard").show();
    $("#resultReport").hide();
    updatefooter();
}

function getTopic(text) {
    text = text.toLowerCase();
    for (let tema in TEMAS) {
        if (TEMAS[tema].some(key => text.includes(key))) return tema;
    }
    return "Otros / General";
}

function checkAnswer() {
    let question = arr[rand];
    let splited = question.answer.split(", ");
    let userAnswer = [];
    let type = (question.options) ? (splited.length === 1 ? 1 : 2) : 3;

    if (type === 1) {
        let val = $("input[name='answer']:checked").val();
        if(val === undefined) return alert("Selecciona una opción");
        userAnswer.push(arrOpt[val]);
    } else if (type === 2) {
        $("input[name='answer']:checked").each(function() { userAnswer.push(arrOpt[$(this).val()]); });
        if(userAnswer.length === 0) return alert("Selecciona al menos una");
    } else {
        userAnswer.push($("#text").val().trim());
    }

    let isCorrect = userAnswer.sort().toString() === splited.sort().toString();
    let topic = getTopic(question.question);

    if (isCorrect) numCorrect++;
    else {
        numIncorrect++;
        errorStats[topic] = (errorStats[topic] || 0) + 1;
    }

    let color = isCorrect ? "#10b981" : "#ef4444";
    $("#answer").append(`
        <div class="feedback-box" style="border-left:5px solid ${color};">
            <p><strong>${isCorrect ? '✅ Correcto' : '❌ Incorrecto'}</strong></p>
            <p><strong>Correcta:</strong> ${question.answer}</p>
            <p><small>Tema: ${topic}</small></p>
            <hr>
            <p>${question.explicacion}</p>
        </div>
    `);

    $("input, button").prop("disabled", true);
    $("#buttons").html("<button onclick='nextQuestion()'>Siguiente</button>");
    updatefooter();
}

function nextQuestion() {
    if (preguntas_hechas.length >= arr.length) return showFinalReport();

    do {
        rand = Math.floor(Math.random() * arr.length);
    } while (preguntas_hechas.includes(rand));

    preguntas_hechas.push(rand);
    let q = arr[rand];
    
    $("#question").html(`<h2>${q.question}</h2>`);
    $("#answer").html(generateOptions(q));
    $("#buttons").html("<button onclick='checkAnswer()'>Verificar</button>");
}

function generateOptions(q) {
    let splited = q.answer.split(", ");
    let type = (q.options) ? (splited.length === 1 ? 1 : 2) : 3;
    
    if (type === 3) return '<input type="text" id="text" class="input-modern" placeholder="Escribe comando...">';
    
    // Añadimos la clase 'option-row' para controlarla por CSS
    return q.options.map((opt, i) => `
        <div class="option-row">
            <label class="option-container">
                <input type="${type === 1 ? 'radio' : 'checkbox'}" name="answer" value="${i}">
                <span class="option-text">${opt}</span>
            </label>
        </div>
    `).join("");
}

function showFinalReport() {
    $("#mainCard").hide();
    $("#resultReport").show();
    let perc = ((numCorrect / preguntas_hechas.length) * 100).toFixed(1);
    
    $("#summaryStats").html(`
        <div class="final-score">${perc}%</div>
        <p>Aciertos: ${numCorrect} | Fallos: ${numIncorrect}</p>
    `);

    let analysisHtml = "<ul>";
    let sorted = Object.entries(errorStats).sort((a,b) => b[1]-a[1]);
    sorted.forEach(([tema, fallos]) => {
        analysisHtml += `<li><strong>${tema}:</strong> ${fallos} fallos</li>`;
    });
    $("#topicAnalysis").html(analysisHtml + "</ul>");
}

function updatefooter() {
    $("#number").text(preguntas_hechas.length);
    $("#correct").text(numCorrect);
    $("#incorrect").text(numIncorrect);
    let perc = preguntas_hechas.length > 0 ? ((numCorrect / preguntas_hechas.length) * 100).toFixed(0) : 0;
    $("#percentage").text(perc + "%");
}

$(document).ready(() => {
    $("#examSelect").on('change', function() { switchExam($(this).val()); });
    $("#toggleDarkMode").click(() => {
        $("body").toggleClass("dark-mode");
        localStorage.setItem("darkMode", $("body").hasClass("dark-mode") ? "enabled" : "disabled");
    });
    if (localStorage.getItem("darkMode") === "enabled") $("body").addClass("dark-mode");

    // Iniciar con el primer examen
    switchExam($("#examSelect").val());
    
    setInterval(() => {
        totalSeconds++;
        let m = Math.floor(totalSeconds / 60), s = totalSeconds % 60;
        $("#timer").text(`${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`);
    }, 1000);
});
